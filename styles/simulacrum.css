/* SPDX-License-Identifier: MIT */
/* Copyright © 2024-2025 Aaron Riechert */

/* 
 * MINIMAL Simulacrum styling - inherit EVERYTHING from FoundryVTT 
 * Only essential settings and legacy panel compatibility
 */

/* ---------------------------------------- */
/*  Simulacrum Sidebar Layout Fix          */
/* ---------------------------------------- */

/* Make simulacrum sidebar use flexbox layout like chat */
/* Match Chat tab container layout */
#sidebar-content #simulacrum {
  padding: 4px 0;
  overflow: hidden;
  align-items: flex-end;
  width: 100%;
  gap: 8px;
}

#sidebar-content #simulacrum .chat-log {
  direction: ltr;
  max-width: var(--sidebar-width);
}

#sidebar-content #simulacrum .chat-scroll {
  direction: rtl;
}

/* Privacy Buttons */
#simulacrum-chat-controls section {
  display: flex;
  flex-direction: row;
  margin: 0;
  border: none;
  border-radius: 0;
}

/* Ensure flex column behavior for inner layout */
#simulacrum {
  display: flex;
  flex-direction: column;
  height: 100%;
}

/* Chat scroll should fill remaining vertical space */
#simulacrum .chat-scroll {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}

/* Chat form should be anchored to bottom */
#simulacrum .chat-form {
  flex: none;
}

/* Legacy panel styling (kept for backwards compatibility only) */
.simulacrum-panel {
  min-width: 400px;
  min-height: 300px;
}

.simulacrum-panel .window-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.simulacrum-panel .chat-log {
  flex-grow: 1;
  overflow-y: auto;
  padding: 5px;
  background: rgba(0, 0, 0, 0.05);
  border: 1px solid var(--color-border-dark);
  margin-bottom: 5px;
}

.simulacrum-panel .chat-input {
  display: flex;
}

.simulacrum-panel .chat-input textarea {
  flex-grow: 1;
  resize: none;
  margin-right: 5px;
}

/* ---------------------------------------- */
/*  Tool Permissions / Hidden Form Styling */
/* ---------------------------------------- */


.simulacrum-sidebar-tab .chat-form.hidden {
  display: none !important;
}

/* ---------------------------------------- */
/*  Settings Interface Styling             */
/* ---------------------------------------- */

.simulacrum-settings {
  min-width: 600px;
}

.simulacrum-settings .form-group {
  margin-bottom: 1rem;
}

.simulacrum-settings .form-group label {
  display: block;
  font-weight: bold;
  margin-bottom: 0.25rem;
  color: var(--color-text-dark-primary);
}

/* Chat Controls */
/* Chat Controls - Commented out to match standard styling */
/*
#simulacrum-chat-controls {
  flex: 0 0 auto;
  margin: 5px;
  border: 1px solid var(--color-border-dark);
  border-radius: 4px;
  background-color: var(--color-cool-4);
}
*/

/* Replicating #chat-message styles from foundry2.css */
#simulacrum-chat-message {
  --input-text-color: var(--text-color, var(--color-light-2));
  --input-placeholder-color: var(--placeholder-color, var(--color-light-5));
  margin: 0;
  padding: var(--chat-message-spacing, 4px);
  /* Default to 4px if var undefined */
  width: 100%;
  resize: none;
  background: var(--background-color, var(--color-cool-5));
  border: 2px solid var(--border-color, var(--color-cool-4));
  font-family: var(--font-body);
  transition:
    box-shadow 250ms,
    outline 250ms;
}

#simulacrum-chat-message::placeholder {
  font-size: var(--font-size-16);
  font-style: italic;
}

#simulacrum-chat-message:placeholder-shown:not(:focus) {
  place-content: center;
  text-align: center;
}

#simulacrum-chat-message:focus {
  outline-color: var(--color-warm-1);
}

#simulacrum-chat-message:focus::placeholder {
  color: transparent;
}

.simulacrum-settings .form-group input,
.simulacrum-settings .form-group select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--color-border-dark);
  border-radius: 3px;
  background: var(--color-bg-input);
  color: var(--color-text-light-primary);
}

.simulacrum-settings .form-group input[type='checkbox'] {
  width: auto;
  margin-right: 0.5rem;
}

.simulacrum-settings .form-group input.valid {
  border-color: #28a745;
  box-shadow: 0 0 0 0.125rem rgba(40, 167, 69, 0.25);
}

.simulacrum-settings .form-group input.invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 0.125rem rgba(220, 53, 69, 0.25);
}

.simulacrum-settings .hint {
  font-size: 0.8rem;
  color: var(--color-text-dark-secondary);
  margin-top: 0.25rem;
  margin-bottom: 0;
}

.simulacrum-settings .connection-test {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.simulacrum-settings .test-connection {
  background: var(--color-primary);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.simulacrum-settings .test-connection:hover:not(:disabled) {
  background: var(--color-primary-dark);
}

.simulacrum-settings .test-connection:disabled {
  background: var(--color-border-dark);
  cursor: not-allowed;
}

.simulacrum-settings .reset-defaults {
  background: var(--color-warning);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 3px;
  cursor: pointer;
  transition: background-color 0.2s;
}

.simulacrum-settings .reset-defaults:hover {
  background: var(--color-warning-dark);
}

.simulacrum-settings .sheet-footer {
  border-top: 1px solid var(--color-border-dark);
  padding-top: 1rem;
  margin-top: 1rem;
  text-align: right;
}

.simulacrum-settings .sheet-footer button[type='submit'] {
  background: var(--color-success);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 3px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.2s;
}

.simulacrum-settings .sheet-footer button[type='submit']:hover {
  background: var(--color-success-dark);
}

/* ---------------------------------------- */
/*  Sidebar Tab Visibility Control         */
/* ---------------------------------------- */

/* Hide simulacrum content when not active */
#sidebar-content:not(.active-simulacrum) #simulacrum {
  display: none;
}

/* Show simulacrum content only when active */
#sidebar-content.active-simulacrum #simulacrum {
  display: flex;
}

/* ---------------------------------------- */
/*  AI Thoughts Collapsible Styling        */
/* ---------------------------------------- */

/* Container for collapsible AI thoughts */
.simulacrum-thoughts {
  margin: 0.5rem 0;
  border: 1px solid var(--color-border-light);
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.02);
  overflow: hidden;
}

/* Clickable summary (collapsed state) */
.simulacrum-thoughts summary {
  padding: 0.5rem 0.75rem;
  background: var(--color-bg-option);
  border-bottom: 1px solid var(--color-border-light);
  cursor: pointer;
  user-select: none;
  font-weight: 500;
  color: var(--color-text-dark-secondary);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: background-color 0.2s ease;
}

.simulacrum-thoughts summary:hover {
  background: var(--color-bg-option-hover);
}

/* Remove default marker and add custom styling */
.simulacrum-thoughts summary {
  list-style: none;
}

.simulacrum-thoughts summary::-webkit-details-marker {
  display: none;
}

/* Add custom expand/collapse indicator */
.simulacrum-thoughts summary::after {
  content: '▶';
  margin-left: auto;
  transition: transform 0.2s ease;
  font-size: 0.8em;
}

.simulacrum-thoughts[open] summary::after {
  transform: rotate(90deg);
}

/* Content area styling */
.simulacrum-thoughts .think-content {
  padding: 0.75rem;
  background: rgba(0, 0, 0, 0.01);
  font-family: var(--font-mono, 'Courier New', monospace);
  font-size: 0.9em;
  line-height: 1.4;
  color: var(--color-text-dark-secondary);
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* Subtle styling for the thought content */
.simulacrum-thoughts .think-content br {
  line-height: 1.6;
}

/* Dark theme adjustments */
.dark .simulacrum-thoughts {
  background: rgba(255, 255, 255, 0.02);
  border-color: var(--color-border-dark);
}

.dark .simulacrum-thoughts .think-content {
  background: rgba(255, 255, 255, 0.01);
}

.dark .simulacrum-tool-call {
  background: rgba(255, 255, 255, 0.05);
}

/* ---------------------------------------- */
/*  Tool Permissions / Hidden Form Styling */
/* ---------------------------------------- */



.simulacrum-sidebar-tab .chat-form.hidden {
  display: none !important;
}

/* ---------------------------------------- */
/*  Task-20: Custom Fonts                  */
/* ---------------------------------------- */

@font-face {
  font-family: 'Dumbledor';
  src: url('../assets/fonts/dumbledor.ttf') format('truetype');
}

/* Default font for Simulacrum UI */
#simulacrum {
  font-family: 'Roboto', sans-serif;
}

/* Header Fonts - Modesto Condensed - Strictly Scoped to ID */
#simulacrum .chat-message .message-header,
#simulacrum .chat-message .message-header .title,
#simulacrum .chat-message h1,
#simulacrum .chat-message h2,
#simulacrum .chat-message h3,
#simulacrum .chat-message h4,
.simulacrum-panel .chat-message h4 {
  font-family: 'Modesto Condensed', 'Modesto', serif !important;
  letter-spacing: 0.05em;
}

/* Header Sizing - Subdued for Sidebar */
#simulacrum .chat-message h1 {
  font-size: 1.75em;
  margin: 0.3em 0;
  line-height: 1.2;
  color: white;
}

#simulacrum .chat-message h2 {
  font-size: 1.5em;
  margin: 0.4em 0;
  line-height: 1.2;
  color: white;
}

#simulacrum .chat-message h3 {
  font-size: 1.35em;
  margin: 0.5em 0;
  line-height: 1.2;
  color: white;
}

#simulacrum .chat-message h4 {
  font-size: 1.25em;
  margin: 0.5em 0;
  line-height: 1.2;
  color: white;
}

/* Body Text Fonts - Roboto - Strictly Scoped to ID */
#simulacrum .chat-message .message-content,
#simulacrum .chat-message .message-content p,
#simulacrum .chat-message .message-content div,
#simulacrum .chat-message .message-content span,
#simulacrum .chat-message .message-content li,
.simulacrum-panel .chat-message .message-content {
  font-family: 'Roboto', sans-serif !important;
  letter-spacing: normal;
}

/* ---------------------------------------- */
/*  Task-19: Chat Message Styling          */
/* ---------------------------------------- */

/* Dark customized background for AI messages - Dark Indigo */
/* System-agnostic: use high specificity to override system stylesheets */
/* Specificity: ID (1-0-0) + classes beats most system selectors */
#simulacrum .chat-message.simulacrum-chat-message,
#chat-log .chat-message.simulacrum-chat-message,
.chat-popout .chat-message.simulacrum-chat-message,
.chat-message.message.simulacrum-chat-message {
  background-color: #1a1625;
  background-image: none;
  background: #1a1625;
  color: #fff4c2;
  border: 1px solid #4b4a45;
  box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
  position: relative;
  overflow: hidden;
  /* Ensure texture stays contained */
}

/* User messages - Slightly more blue for distinction */
/* High specificity to override system styles */
#simulacrum .chat-message.simulacrum-chat-message.simulacrum-role-user,
#chat-log .chat-message.simulacrum-chat-message.simulacrum-role-user,
.chat-popout .chat-message.simulacrum-chat-message.simulacrum-role-user,
.chat-message.message.simulacrum-chat-message.simulacrum-role-user {
  background-color: #101318;
  background-image: none;
  background: #101318;
  color: #fff4c2;
  /* Deep Obsidian Blue */
}

/* Pale gold text for header and content */
/* Pale gold text for header and content */
/* Removed gradient text to fix readability/outline issues */
/* Pale gold text for header and content */
/* Removed gradient text to fix readability/outline issues */
.simulacrum-chat-message .message-header,
.simulacrum-chat-message .message-content,
.simulacrum-chat-message .message-header .title,
.simulacrum-chat-message .message-content i {
  color: #fff4c2;
  /* Very pale gold */
  text-shadow: 0 0 5px rgba(218, 165, 32, 0.5);
  /* Reverted radius to 5px, 50% opacity */
  position: relative;
  z-index: 1;
}

/* Fix for elements that shouldn't be transparent/gradient text */
.simulacrum-chat-message .message-header .message-metadata,
.simulacrum-chat-message .message-sender,
.simulacrum-chat-message .message-timestamp,
.simulacrum-chat-message .message-header .title {
  color: #fff4c2;
  text-shadow: 0 0 5px rgba(218, 165, 32, 0.5);
}

/* Subtle texture overlay - System-agnostic noise pattern */
.chat-message.simulacrum-chat-message::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /* CSS-only subtle noise texture (no external image dependency) */
  background-image:
    radial-gradient(ellipse at 20% 30%, rgba(255, 244, 194, 0.03) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(218, 165, 32, 0.02) 0%, transparent 50%);
  background-size: 100% 100%;
  opacity: 1;
  pointer-events: none;
  z-index: 0;
}

.chat-message.simulacrum-chat-message.process-status-message::before {
  background-image: none;
}

/* Ensure links and icons are visible on dark background */
.simulacrum-chat-message a.content-link,
.simulacrum-chat-message a.inline-roll {
  color: #ffd700;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid #7a7971;
}

/* ---------------------------------------- */
/*  Process Status Spinner Fix             */
/* ---------------------------------------- */

/* Ensure texture overlay is removed for process status message */
:is(.chat-popout, #chat-log, .chat-log) .message.process-status-message {
  background: none;
  border: none;
  color: #ffd79a;
}

:is(.chat-popout, #chat-log, .chat-log) .message.process-status-message::before {
  background: none;
}

/* Fix spinner rotation center point by ensuring square dimensions */
.simulacrum-process-spinner {
  width: 12px !important;
  height: 12px !important;
  font-size: 12px !important;
  line-height: 12px !important;
  display: inline-block !important;
  text-align: center !important;
  box-sizing: border-box !important;
  /* Ensure the icon rotates around its center */
  transform-origin: center center !important;
  /* Warm gold color for spinner - matches label */
  color: #ffd79a;
}

/* ---------------------------------------- */
/*  Thinking Indicator Styling (Task-17)   */
/* ---------------------------------------- */

/* Process status message container - transparent, no border */
/* High specificity to override Foundry's .chat-message styles */
#simulacrum .chat-message.process-status-message,
.simulacrum-sidebar-tab .chat-message.process-status-message {
  background: none;
  border: none;
  box-shadow: none;
}

#simulacrum .chat-message.process-status-message .message-content,
.simulacrum-sidebar-tab .chat-message.process-status-message .message-content {
  text-align: left;
  margin-top: -8px;
}

/* Process status container - clean inline layout */
#simulacrum .process-status,
.simulacrum-sidebar-tab .process-status {
  font-size: 1.2em;
  align-items: center;
  background: transparent;
  font-style: italic;
}

/* Thinking text - warm gold to match established palette */
#simulacrum .process-status .label,
.simulacrum-sidebar-tab .process-status .label {
  padding-left: 4px;
  color: #ffd79a;
  font-weight: 500;
  /* Task-16: Smooth transition for word rotation */
  transition: opacity 0.2s ease-in-out;
}

/* Retry warning state - strong orange/yellow for connection errors */
#simulacrum .process-status-message.retry-warning .process-status .label,
.simulacrum-sidebar-tab .process-status-message.retry-warning .process-status .label {
  color: #ff9800;
  font-weight: 600;
}

#simulacrum .process-status-message.retry-warning .simulacrum-process-spinner,
.simulacrum-sidebar-tab .process-status-message.retry-warning .simulacrum-process-spinner {
  color: #ff9800;
}

#simulacrum .process-status-message.retry-warning .message-content,
.simulacrum-sidebar-tab .process-status-message.retry-warning .message-content {
  background: rgba(255, 152, 0, 0.1);
  border-left: 3px solid #ff9800;
  padding-left: 8px;
}

/* ---------------------------------------- */
/*  Sidebar Icon Glow (Task-18)            */
/* ---------------------------------------- */

/* Sidebar Tab Styling - Correctly target the button element */
#sidebar-tabs .ui-control.icon[data-tab='simulacrum'] {
  background-color: #1a1625;
  border: 1px solid #4b4a45;
  border-radius: 4px;
  /* Icon styling directly on the button */
  color: #fff4c2;
  text-shadow: 0 0 5px rgba(218, 165, 32, 0.5);
  transition: all 0.3s ease;
}

/* Hover State */
#sidebar-tabs .ui-control.icon[data-tab='simulacrum']:hover {
  border-color: #daa520;
  box-shadow: 0 0 5px rgba(218, 165, 32, 0.3);
}

/* Active State */
#sidebar-tabs .ui-control.icon[data-tab='simulacrum'].active,
#sidebar-tabs .ui-control.icon[data-tab='simulacrum'][aria-pressed='true'] {
  color: #fff4c2;
  text-shadow: 0 0 8px rgba(218, 165, 32, 0.8);
  background-color: #1a1625;
  border-color: #665c3b;
}

/* ---------------------------------------- */
/*  Code Block Whitespace Fix              */
/* ---------------------------------------- */

/* Fix code block newline collapse in Simulacrum chat messages only */
/* Use high-specificity selectors to override FoundryVTT's white-space: nowrap */

/* Code blocks within pre tags (multiline code) */
#simulacrum .chat-message .message-content pre code,
#simulacrum .chat-message .message-content code.block {
  white-space: pre-wrap;
  word-break: normal;
}

/* Pre elements preserve whitespace and allow horizontal scrolling */
#simulacrum .chat-message .message-content pre {
  white-space: pre-wrap;
  overflow-x: auto;
}

/* Inline code elements allow wrapping for long lines */
#simulacrum .chat-message .message-content p code,
#simulacrum .chat-message .message-content li code,
#simulacrum .chat-message .message-content span code,
#simulacrum .chat-message .message-content code.inline {
  white-space: pre-wrap;
  word-break: break-word;
}

/* ---------------------------------------- */
/*  Tool Call Status Indicators (Task-09)  */
/* ---------------------------------------- */

/* Container for tool call results */
.simulacrum-tool-results {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid var(--color-border-light);
}

/* Individual tool call indicator */
.simulacrum-tool-call {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.5rem;
  padding: 0.35rem 0.5rem;
  margin: 0.25rem 0;
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.03);
  font-size: 0.9em;
  line-height: 1.4;
}

/* Tool status icon base */
.simulacrum-tool-call .tool-icon {
  flex-shrink: 0;
  width: 1em;
  text-align: center;
}

/* Success indicator */
.simulacrum-tool-call.tool-success .tool-icon {
  color: var(--color-success, #28a745);
}

/* Failure indicator */
.simulacrum-tool-call.tool-failure .tool-icon {
  color: var(--color-warning, #dc3545);
}

/* Pending indicator - spinning gold icon */
.simulacrum-tool-call.tool-pending .tool-icon {
  color: #daa520;
}

/* Pending tool wrapper - ephemeral, removed when result arrives */
.pending-tool-wrapper {
  opacity: 0.9;
}

/* Tool name/action text */
.simulacrum-tool-call .tool-action {
  font-weight: 500;
  color: var(--color-text-dark-secondary);
  white-space: nowrap;
}

/* Document link styling */
.simulacrum-tool-call .tool-document {
  color: var(--color-primary, #5e81ac);
  font-style: italic;
}

/* Dark theme adjustments */
.dark .simulacrum-tool-call {
  background: rgba(255, 255, 255, 0.05);
}

/* Tool Result Display - Force new line */
.simulacrum-tool-call .tool-result-display {
  flex-basis: 100%;
  width: 100%;
  margin-top: 4px;
}

/* Tool Justification inside tool card - more compact */
.simulacrum-tool-call .tool-justification {
  flex-basis: 100%;
  width: 100%;
  margin: 0.25rem 0 0 0;
  padding: 0.35rem 0.5rem;
  background: rgba(218, 165, 32, 0.1);
  border-left: 2px solid #daa520;
  border-radius: 0 4px 4px 0;
  font-size: 0.9em;
}

.simulacrum-tool-call .tool-justification p {
  margin: 0;
  color: var(--color-text-dark-secondary, #888);
  font-style: italic;
}

/* Collapsed justification for completed tools - 1 line with ellipsis */
.simulacrum-tool-call.tool-success .tool-justification p,
.simulacrum-tool-call.tool-failure .tool-justification p {
  display: -webkit-box;
  -webkit-line-clamp: 1;
  -webkit-box-orient: vertical;
  overflow: hidden;
  cursor: pointer;
}

/* Expand on click (using expanded class toggled by JS) */
.simulacrum-tool-call.tool-success .tool-justification.expanded p,
.simulacrum-tool-call.tool-failure .tool-justification.expanded p {
  -webkit-line-clamp: unset;
  display: block;
}

.dark .simulacrum-tool-call .tool-justification p {
  color: #c9b68e;
}

/* Task steps list styling */
.task-steps {
  list-style: none;
  padding-left: 0;
  margin: 0.5rem 0;
  display: block;
}

.task-steps li {
  padding: 0.5rem 0;
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  line-height: 1.5;
  border-bottom: 1px solid rgba(128, 128, 128, 0.15);
}

.task-steps li:last-child {
  border-bottom: none;
}

.task-steps li .step-content {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
  flex: 1;
}

.task-steps li .step-title {
  font-weight: 600;
}

.task-steps li .step-desc {
  font-weight: normal;
  opacity: 0.85;
  font-size: 0.95em;
}

.task-steps li.current-step .step-title {
  color: #daa520;
}

/* Collapsible task details */
.task-details {
  margin: 0.25rem 0;
}

.task-details summary {
  cursor: pointer;
  list-style: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.35rem 0;
}

.task-details summary::-webkit-details-marker {
  display: none;
}

.task-details summary::before {
  content: '\f0da';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  width: 0.8em;
  transition: transform 0.2s;
}

.task-details[open] summary::before {
  transform: rotate(90deg);
}

.task-details .task-progress {
  opacity: 0.6;
  font-size: 0.9em;
}

.task-details .task-expanded {
  padding: 0.5rem 0 0.5rem 1.5rem;
  border-left: 2px solid rgba(128, 128, 128, 0.3);
  margin-left: 0.4rem;
}

.task-details .task-expanded h4 {
  margin: 0 0 0.25rem 0;
  font-size: 1em;
}

.task-details .task-goal {
  margin: 0 0 0.5rem 0;
  opacity: 0.8;
  font-size: 0.9em;
}

.task-steps li i {
  margin-top: 0.2em;
  width: 1.2em;
  text-align: center;
  flex-shrink: 0;
}

.task-steps li i.fa-circle-check {
  color: var(--color-success, #28a745);
}

.task-steps li i.fa-circle-notch {
  color: #daa520;
}

.task-steps li i.fa-square {
  color: var(--color-text-dark-secondary, #666);
}

/* ---------------------------------------- */
/*  Task Tracker (Sibling to chat-scroll)  */
/* ---------------------------------------- */

.task-tracker {
  background: linear-gradient(135deg, rgba(26, 22, 37, 0.98) 0%, rgba(16, 19, 24, 0.98) 100%);
  border-bottom: 1px solid rgba(218, 165, 32, 0.3);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  padding: 0.5rem 0.75rem;
  flex-shrink: 0;
  width: calc(var(--sidebar-width) - var(--chat-message-spacing) * 2);
  margin-right: var(--chat-message-spacing);
}

.task-tracker-header {
  display: flex;
  align-items: flex-start;
  gap: 0.5rem;
  cursor: pointer;
}

.task-tracker-header .task-tracker-icon {
  color: #daa520;
  font-size: 1em;
  margin-top: 0.15em;
}

/* 2-line info container */
.task-tracker-header .task-tracker-info {
  display: flex;
  flex-direction: column;
  flex: 1;
  gap: 0.1rem;
  min-width: 0;
}

.task-tracker-header .task-tracker-title {
  font-weight: 600;
  color: #fff4c2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.task-tracker-header .task-tracker-step-info {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.85em;
  opacity: 0.8;
}

.task-tracker-header .task-tracker-step {
  color: #c9b68e;
}

.task-tracker-header .task-tracker-progress {
  opacity: 0.6;
  font-size: 0.9em;
}

.task-tracker-header .task-tracker-toggle {
  background: none;
  border: none;
  color: inherit;
  cursor: pointer;
  padding: 0.25rem;
  opacity: 0.6;
  transition: opacity 0.2s, transform 0.2s;
  align-self: center;
}

.task-tracker-header .task-tracker-toggle:hover {
  opacity: 1;
}

.task-tracker.expanded .task-tracker-toggle i {
  transform: rotate(180deg);
}

.task-tracker-body {
  display: none;
  padding-top: 0.5rem;
  margin-top: 0.5rem;
  border-top: 1px solid rgba(128, 128, 128, 0.2);
}

.task-tracker.expanded .task-tracker-body {
  display: block;
}

.task-tracker-body .task-tracker-name {
  margin: 0 0 0.25rem 0;
  font-size: 0.95em;
  color: #fff4c2;
}

.task-tracker-body .task-tracker-goal {
  margin: 0 0 0.5rem 0;
  font-size: 0.85em;
  opacity: 0.8;
}

.task-tracker-body .task-tracker-steps {
  list-style: none;
  padding: 0;
  margin: 0;
  font-size: 0.85em;
}

.task-tracker-body .task-tracker-steps li {
  display: flex;
  align-items: flex-start;
  gap: 0.4rem;
  padding: 0.25rem 0;
  opacity: 0.7;
}

.task-tracker-body .task-tracker-steps li.current-step {
  opacity: 1;
  font-weight: 600;
}

.task-tracker-body .task-tracker-steps li.completed-step {
  opacity: 0.5;
}

.task-tracker-body .task-tracker-steps li i {
  width: 1em;
  text-align: center;
  flex-shrink: 0;
  margin-top: 0.15em;
}

.task-tracker-body .task-tracker-steps li i.fa-circle-check {
  color: var(--color-success, #28a745);
}

.task-tracker-body .task-tracker-steps li i.fa-circle-notch {
  color: #daa520;
}

.task-tracker-body .task-tracker-steps li i.fa-square {
  color: var(--color-text-dark-secondary, #666);
}

/* ---------------------------------------- */
/*  Jump to Bottom Button Styling (Fix)    */
/* ---------------------------------------- */

#simulacrum .chat-form {
  position: relative;
}

/* Scrolled state mask - bottom fade when content below */
.chat-sidebar .chat-scroll.scrolled {
  mask-image: linear-gradient(to bottom, black 0%, black 95%, transparent);
  -webkit-mask-image: linear-gradient(to bottom, black 0%, black 95%, transparent);
}

/* Top fade when task-tracker visible and scrolled from top */
.task-tracker:not([style*="none"])~.chat-scroll.not-at-top {
  mask-image: linear-gradient(to bottom, transparent, black 5%, black 100%);
  -webkit-mask-image: linear-gradient(to bottom, transparent, black 5%, black 100%);
}

/* Both fades: task-tracker visible, not at top, AND content below */
.task-tracker:not([style*="none"])~.chat-scroll.not-at-top.scrolled {
  mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
  -webkit-mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
}

/* ---------------------------------------- */
/*  Table Styling Alignment (Simulacrum)   */
/* ---------------------------------------- */

/* Override system table colors to align with Simulacrum theme */
/* System-agnostic: define our own custom properties, no --dnd5e-* dependencies */
.simulacrum-chat-message {
  /* Simulacrum Table Variables (system-agnostic) */
  --simulacrum-table-bg: rgba(16, 19, 24, 0.5);
  --simulacrum-table-header-bg: #1a1625;
  --simulacrum-table-header-bg-alt: #302831;
  --simulacrum-table-header-border: #665c3b;
  --simulacrum-table-header-text: #fff4c2;
  --simulacrum-table-row-even: rgba(255, 244, 194, 0.05);
  --simulacrum-table-row-odd: transparent;
  --simulacrum-table-border: #4b4a45;

  /* Legacy compatibility: also set --dnd5e-* for systems that use them */
  --dnd5e-color-table-header-1: var(--simulacrum-table-header-bg);
  --dnd5e-color-table-header-2: var(--simulacrum-table-header-bg-alt);
  --dnd5e-color-table-row-even: var(--simulacrum-table-row-even);
  --dnd5e-color-table-row-odd: var(--simulacrum-table-row-odd);
  --dnd5e-color-table-border: var(--simulacrum-table-border);
}

/* Force table text color to match message text */
.simulacrum-chat-message table {
  color: #fff4c2;
  border-color: #4b4a45;
}

.simulacrum-chat-message table expected {
  color: #fff4c2;
}

.simulacrum-chat-message table thead,
.simulacrum-chat-message table th {
  color: #fff4c2;
  text-shadow: none;
  /* Remove shadow for readability */
  border-color: #665c3b;
}

.simulacrum-chat-message table td {
  border-color: #4b4a45;
}


/* ---------------------------------------- */
/*  Table Styling Alignment (Simulacrum)   */
/* ---------------------------------------- */

/* 
 * Specificity Calculation to beat System Styles:
 * System: .themed.theme-light.dnd5e2 table (0-3-1)
 *
 * Strategy: Use ID-based selectors where possible, or high class specificity.
 * Sidebar: #simulacrum .simulacrum-chat-message table (1-1-1) > (0-3-1)
 * Popout:  .chat-popout .simulacrum-chat-message table (0-2-1) -> LOSE
 *          body .chat-popout .simulacrum-chat-message table (0-2-2) -> LOSE
 *          .app.chat-popout .simulacrum-chat-message table (0-3-1) -> TIE (Position wins if later)
 *          .app.chat-popout .chat-message.simulacrum-chat-message table (0-4-1) -> WIN
 */

/* Target 1: Sidebar (ID specificity wins easily) */
#simulacrum .simulacrum-chat-message table {
  background: rgba(16, 19, 24, 0.5);
  --table-background-color: rgba(16, 19, 24, 0.5);
}

#simulacrum .simulacrum-chat-message table tr:nth-child(2n+1) {
  background-color: transparent;
  --dnd5e-color-table-row-odd: transparent;
  --table-row-color-odd: transparent;
}

#simulacrum .simulacrum-chat-message table tr:nth-child(2n) {
  background-color: rgba(255, 244, 194, 0.05);
  --dnd5e-color-table-row-even: rgba(255, 244, 194, 0.05);
}

#simulacrum .simulacrum-chat-message table thead,
#simulacrum .simulacrum-chat-message table th {
  background: #1a1625;
  color: #fff4c2;
  border-color: #665c3b;
}

/* Target 2: Popouts / General (High class specificity to beat system) */
.app.chat-popout .chat-message.simulacrum-chat-message table,
.chat-log .chat-message.simulacrum-chat-message table {
  background: rgba(16, 19, 24, 0.5);
  --table-background-color: rgba(16, 19, 24, 0.5);
}

.app.chat-popout .chat-message.simulacrum-chat-message table tr:nth-child(2n+1),
.chat-log .chat-message.simulacrum-chat-message table tr:nth-child(2n+1) {
  background-color: transparent;
  --dnd5e-color-table-row-odd: transparent;
  --table-row-color-odd: transparent;
}

.app.chat-popout .chat-message.simulacrum-chat-message table tr:nth-child(2n),
.chat-log .chat-message.simulacrum-chat-message table tr:nth-child(2n) {
  background-color: rgba(255, 244, 194, 0.05);
  --dnd5e-color-table-row-even: rgba(255, 244, 194, 0.05);
}

.app.chat-popout .chat-message.simulacrum-chat-message table thead,
.chat-log .chat-message.simulacrum-chat-message table thead,
.app.chat-popout .chat-message.simulacrum-chat-message table th,
.chat-log .chat-message.simulacrum-chat-message table th {
  background: #1a1625;
  color: #fff4c2;
  border-color: #665c3b;
}

/* Ensure text color is always enforced on table elements */
#simulacrum .simulacrum-chat-message table,
.chat-message.simulacrum-chat-message table {
  color: #fff4c2;
  border-color: #4b4a45;
}

#simulacrum .simulacrum-chat-message table td,
.chat-message.simulacrum-chat-message table td {
  border-color: #4b4a45;
}

/* ---------------------------------------- */
/*  Access Denied Message (GM-Only)        */
/* ---------------------------------------- */

/* Styling for the GM-only access denied message */
#simulacrum .access-denied-message,
.simulacrum-sidebar-tab .access-denied-message {
  background: transparent;
  border: none;
  box-shadow: none;
  padding: 2rem 1rem;
}

#simulacrum .access-denied-text,
.simulacrum-sidebar-tab .access-denied-text {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  color: #999;
  font-size: 1.1em;
  text-align: center;
}

#simulacrum .access-denied-text i,
.simulacrum-sidebar-tab .access-denied-text i {
  font-size: 1.2em;
  color: #888;
}

/* ---------------------------------------- */
/*  Tool Confirmation UI (Destructive Tools)*/
/* ---------------------------------------- */

/* Container for tool confirmation prompt */
.simulacrum-tool-confirmation {
  background: linear-gradient(135deg, #1a1625 0%, #2d2438 100%);
  border: 2px solid #665c3b;
  border-radius: 8px;
  padding: 0.75rem;
  margin: 0.5rem 0;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

/* Header with shield icon */
.simulacrum-tool-confirmation .tool-confirmation-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  color: #ffd700;
  font-weight: 600;
  font-size: 0.95em;
}

.simulacrum-tool-confirmation .tool-confirmation-header i {
  font-size: 1.1em;
}

/* Body content */
.simulacrum-tool-confirmation .tool-confirmation-body {
  margin-bottom: 0.75rem;
}

.simulacrum-tool-confirmation .tool-info {
  color: #fff4c2;
  margin-bottom: 0.5rem;
}

.simulacrum-tool-confirmation .tool-info .tool-name {
  color: #ffd700;
  font-size: 1.05em;
}

.simulacrum-tool-confirmation .tool-info .wants-to {
  color: #aaa;
  font-style: italic;
  margin-left: 0.25rem;
}

.simulacrum-tool-confirmation .tool-explainer {
  color: #999;
  font-size: 0.85em;
  line-height: 1.4;
  padding: 0.5rem;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
  border-left: 3px solid #665c3b;
}

/* Tool arguments details */
.simulacrum-tool-confirmation .tool-args-details {
  margin-top: 0.5rem;
}

.simulacrum-tool-confirmation .tool-args-details summary {
  color: #888;
  font-size: 0.8em;
  cursor: pointer;
  user-select: none;
}

.simulacrum-tool-confirmation .tool-args-details summary:hover {
  color: #aaa;
}

.simulacrum-tool-confirmation .tool-args {
  font-size: 0.75em;
  background: rgba(0, 0, 0, 0.3);
  padding: 0.5rem;
  border-radius: 4px;
  overflow-x: auto;
  max-height: 100px;
  color: #ccc;
  margin-top: 0.25rem;
}

/* Button container */
.simulacrum-tool-confirmation .tool-confirmation-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

/* Base button styling */
.simulacrum-tool-confirmation .confirm-btn {
  flex: 1 1 auto;
  min-width: 80px;
  padding: 0.4rem 0.6rem;
  border: 1px solid transparent;
  border-radius: 4px;
  font-size: 0.8em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.3rem;
}

.simulacrum-tool-confirmation .confirm-btn i {
  font-size: 0.9em;
}

/* Allow button - Green */
.simulacrum-tool-confirmation .confirm-btn.allow {
  background: #28a745;
  color: white;
  border-color: #28a745;
}

.simulacrum-tool-confirmation .confirm-btn.allow:hover {
  background: #218838;
  box-shadow: 0 0 6px rgba(40, 167, 69, 0.5);
}

/* Deny button - Red */
.simulacrum-tool-confirmation .confirm-btn.deny {
  background: #dc3545;
  color: white;
  border-color: #dc3545;
}

.simulacrum-tool-confirmation .confirm-btn.deny:hover {
  background: #c82333;
  box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
}

/* Always Allow button - Blue */
.simulacrum-tool-confirmation .confirm-btn.always {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.simulacrum-tool-confirmation .confirm-btn.always:hover {
  background: #0069d9;
  box-shadow: 0 0 6px rgba(0, 123, 255, 0.5);
}

/* Blacklist button - Dark/Warning */
.simulacrum-tool-confirmation .confirm-btn.blacklist {
  background: #343a40;
  color: #ffc107;
  border-color: #6c757d;
}

.simulacrum-tool-confirmation .confirm-btn.blacklist:hover {
  background: #23272b;
  border-color: #ffc107;
  box-shadow: 0 0 6px rgba(255, 193, 7, 0.3);
}

/* Responsive: Stack buttons on narrow sidebars */
@media (max-width: 300px) {
  .simulacrum-tool-confirmation .tool-confirmation-buttons {
    flex-direction: column;
  }

  .simulacrum-tool-confirmation .confirm-btn {
    min-width: 100%;
  }
}


/* ---------------------------------------- */
/*  Tool Permissions Configuration Dialog   */
/* ---------------------------------------- */

/* Tool Permissions Configuration - Uses standard Foundry form classes */
/* Relies on 'standard-form' class for system theme compatibility */
#simulacrum-tool-permissions>section:nth-child(3) {
  overflow-y: scroll;
}

/* ---------------------------------------- */
/*  Tool Justification Styling             */
/* ---------------------------------------- */

.tool-justification {
  margin: 0.5rem 0;
  padding: 0.75rem;
  background: rgba(255, 244, 194, 0.05);
  border-left: 3px solid #daa520;
  border-radius: 0 4px 4px 0;
}

.tool-justification p {
  margin: 0;
  color: #fff4c2;
  font-style: italic;
}

.tool-justification strong {
  color: #ffd700;
  font-style: normal;
}

/* ---------------------------------------- */
/*  Step Separator (Task Progress Indicator) */
/* ---------------------------------------- */

/* Minimal 2-line step separator shown when task progresses */
.simulacrum-step-separator {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  margin: 0.5rem 0 0 0;
  font-size: 0.85em;
  color: #888;
  opacity: 0.85;
}

/* Task name - top line, smaller and muted subtext */
.simulacrum-step-separator .step-task-name {
  color: #888;
  font-size: 0.8em;
  font-weight: 400;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 80%;
  margin-bottom: 0.1rem;
}

/* Step info container - bottom line with horizontal separators */
.simulacrum-step-separator .step-info {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
}

/* Horizontal gradient lines */
.simulacrum-step-separator .step-info::before,
.simulacrum-step-separator .step-info::after {
  content: '';
  flex: 1;
  height: 1px;
  background: linear-gradient(to right, transparent, rgba(218, 165, 32, 0.3));
}

.simulacrum-step-separator .step-info::after {
  background: linear-gradient(to left, transparent, rgba(218, 165, 32, 0.3));
}

.simulacrum-step-separator .step-label {
  color: #daa520;
  font-weight: 500;
  font-size: 0.9em;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.simulacrum-step-separator .step-title {
  color: #c9b68e;
  font-style: italic;
}

/* ---------------------------------------- */
/*  Settings Discord Link                   */
/* ---------------------------------------- */

.simulacrum-settings .sheet-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.simulacrum-settings .discord-link {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: #5865F2;
  color: white;
  border-radius: 4px;
  text-decoration: none;
  font-weight: 500;
  transition: background-color 0.2s;
}

.simulacrum-settings .discord-link:hover {
  background: #4752C4;
  color: white;
  text-decoration: none;
}

.simulacrum-settings .discord-link i {
  font-size: 1.1em;
}